#!/bin/sh

set -e

target="`cat debian/target`"

packages="binutils newlib gdb gcc"

stamp='# Generated by debian/setup - DO NOT EDIT\n#\n'
echo -ne "$stamp" > debian/tars.md5
echo -ne "$stamp" > debian/versions

for P in $packages; do
    V="`ls $P-*.tar.* | perl -ne 'm#-([[:digit:].]+)[.]tar[.]#;print "$1\n";' | sort -n -r | head -n 1`"
    F="`ls $P-$V.tar.* | head -n 1`"
    if [ -z "$V" -o ! -f "$F" ]; then
        echo "Broken source package $P." >&2
        exit 1
    fi
    G="`echo $V | cut -d . -f 1-2`"
    echo "$F: found $P $G version $V"
    md5sum -b $F >> debian/tars.md5
    echo "${P}_tar=$F" >> debian/versions
    echo "${P}_vers=$G" >> debian/versions
    echo "${P}_version=$V" >> debian/versions
done

m4opts="`awk '{ if (!/^#/) print "-D"$0}' debian/versions` -DTARGET=$target"

for f in debian/urls debian/control ; do
    echo -ne "$stamp" > $f
    m4 $m4opts $f.in >> $f
done
